---
title: "Aula 3 - Econometria de Séries Temporais"
author: "João Ricardo F. de Lima"
date: "`r format(Sys.time(), '%d de %B de %Y.')`"
output: 
    html_document:
        theme: flatly
        number_sections: yes
        highlight: textmate
#        includes: 
#          in_header: "header.html"
        toc: yes
        toc_float:
          collapsed: yes
          smooth_scroll: yes 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo       = TRUE,
  warning    = FALSE,
  message    = FALSE,
  fig.width  = 9, 
  fig.height = 6,
  fig.align  = "center",
  comment    = "#",
  size       = "normalsize"
  )

#Linhas precisam de ajuste semanal: 30, 104, 201, 204
```

<br>

# Análise da Sazonalidade

<br>

**Variações sazonais** são movimentos cíclicos que se completam no período de um ano e se reproduzem nos outros anos com certa regularidade. Em outras palavras, *sazonalidade* significa dizer que em determinados meses os valores estão sistematicamente acima ou abaixo de um valor médio da série.

Se isola o componente sazonal da série temporal por dois motivos: 

a) remover o componente sazonal para estudar os outros componentes; ou 

b) identificar o componente sazonal que expressam a intensidade da sazonalidade a cada período.

A interdependência temporal na série, então, ocorre de duas maneiras: 

a) correlação entre as observações para meses sucessivos em dado ano, isto é, $Y_t$ relacionado com $Y_{t-1}, Y_{t-2}, Y_{t-3}$, etc; 

b) correlação entre as observações para o mesmo mês em anos sucessivos, ou seja, $Y_t$ relacionado com $Y_{t-s}, Y_{t-2s}, Y_{t-3s}$ em que "s" é o período sazonal considerado.

Considere uma série temporal de volume exportado de mangas. Os volumes de outubro, por exemplo, de todos os anos são correlacionados positivamente; 

Séries sazonais apresentam correlações altas nos *lags sazonais*, que são os lags múltiplos de "s".

<br>

## Gráfico das Exportações de Manga entre 2012 e 2023

<br>

```{r tratamento_base}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Inicio do Script
#Pacotes a serem utilizados 
library(mFilter)
library(forecast)
library(tsutils)
library(seasonal)
library(ggplot2)
library(uroot)
library(tseries)
library(ggthemes)
library(dplyr)
library(quantmod)
library(scales)
library(kableExtra)# complex tables
library(lmtest)
library(FinTS)
library(rbcb)
library(plotly)
library(DT)
library(magrittr)
library(rmarkdown)
library(reshape2)
library(rbcb)
library(tidyverse)
library(lubridate)
library(zoo)

#Entrando dados no R
dados1 <- read.csv2('exportacoes_2012_2023.csv', header=T, sep=";", dec = ".")
dados1 <- dados1/1000
dados1[,1] <- seq(2012, 2023, by = 1)
colnames(dados1) = c('Ano', 'Valor', 'Toneladas')
dados1 <- tibble(dados1)

mycolor1 <- "gold"
mycolor2 <- "red"

g1 <- ggplot(data=dados1) +  #estetica vai valer para todos os geom's
  geom_col(aes(x=Ano, y=Toneladas, fill="Mil Toneladas"), lwd=1)+
    scale_fill_manual(values=mycolor1)+
  geom_line(aes(x=Ano, y=Valor, colour="Milhões de Dólares"), size=2)+
  scale_colour_manual(values=mycolor2)+
  labs(y= "US$ Milhões / Mil Ton", x= "Anos", title='',
       caption = "") +
  scale_y_continuous(limits=c(0, 300), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2012, 2023, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=16, face="italic"),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.25, 
                      y=-0.2,
                      title=''))
```

<br>

## Volume mensal exportado de Mangas

<br>

``` {r econ1, warning=FALSE, message=FALSE}
#Direcionando o R para o Diretorio a ser trabalhado
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Limpa o Ambiente Global
rm(list=ls())

#Inicio do Script
#Pacotes a serem utilizados 
library(foreign)
library(mFilter)
library(forecast)
library(dplyr)
library(tsutils)
library(ggplot2)
library(plotly)
library(reshape2)

atual <-  as.Date("2023-06-01") #ultimo mes disponibilizado
mes <- 6

#Entrando dados no R
dados2 <- read.csv2('total_exporta_br.csv', header=T, sep=";", dec = ".")
#dados <- dados[,-c(9:10)] #retirar as ultimas colunas
colnames(dados2)[1]<-'ano'

#Ajusta para Volume
#Analise de Serie Temporal
exporta_manga_volume <- dados2[,4]
exporta_manga_volume<-exporta_manga_volume/1000  #passando de quilo para

#Setando como uma série temporal
exporta_manga_volume <- ts(exporta_manga_volume, start=c(2012,1), freq=12)

#Grafico da evolucao do volume exportado de manga
plot(exporta_manga_volume, main='Volume mensal exportado de Mangas',
     xlab='Meses dos anos', ylab='Toneladas', lwd=3)
```

<br>

## Decomposição da Série Temporal nos componentes

<br>

```{r econ2, warning=FALSE, message=FALSE}
#Decompor a Serie
decompa <- decompose(exporta_manga_volume, type = 'multiplicative')
plot(decompa)
```

<br>

## Gráfico da Tendência

<br>

```{r econ3, warning=FALSE, message=FALSE}
trend_volume <- cmav(exporta_manga_volume, outplot=F)
date <- seq(as.Date('2012-01-01'),to=atual,by='1 month')
trend_volume <- tibble(date, trend_volume)

g5 <- ggplot(data=trend_volume)+
  geom_line(aes(x=date, y=trend_volume), color="blue", size=1.5)+
  scale_y_continuous(limits=c(0,25000), n.breaks = 10, 
                     expand = expansion(add=c(0,0.5)))+
  scale_x_date(date_breaks = "1 year",
               labels = date_format("%Y"))+
  labs(y= "Tendência", x= "Meses de cada Ano", title='',
       caption = "")+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=12, margin = margin(l=10)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=10)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=10),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10)) # Definindo posição da legenda

ggplotly(g5) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.25, 
                      y=-0.2,
                      title=''))
```

<br>

## Gráfico da Sazonalidade

<br>

```{r econ4, warning=FALSE, message=FALSE}
decompa<-decompose(exporta_manga_volume, type = 'multiplicative')
sazonal_volume <- decompa$figure
meses <- seq(as.Date("2021/1/1"), by = "month", length.out = 12) 
sazonal_graph_volume <- tibble(meses, sazonal_volume)

g6 <- ggplot(data=sazonal_graph_volume)+
  geom_line(aes(x=meses, y=sazonal_volume), color="blue", size=1.5)+
  scale_y_continuous(limits=c(-1,3), n.breaks = 5, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.1)) +
    scale_x_date(date_breaks = "1 month",
               labels = date_format("%B"))+
  labs(y= "", x= "Meses de cada Ano", title='',
       caption = "")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=45, hjust=0.5, size=12, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=12, margin = margin(l=10)),
        axis.title.y = element_text(size=12, face = "bold"),
        axis.title.x = element_text(size=12, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10)) # Definindo posição da legenda

ggplotly(g6) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.25, 
                      y=-0.2,
                      title=''))
```

<br>

## Analise da Sazonalidade com o seasplot

<br>

``` {r econ5, warning=FALSE, message=FALSE}
seasplot(exporta_manga_volume, outplot = 5)
```


<br>


## Comparação da média histórica com 3 últimos anos

``` {r econ6, warning=FALSE, message=FALSE}
#Comparações com os anos e entre as médias/max/min

exporta_manga_volume_2020 <- window(exporta_manga_volume, end=c(2020,12))
seas20_vol<-seasplot(exporta_manga_volume_2020, trend=F, outplot = F)
medias20_vol <- colMeans(seas20_vol$season)

exporta_manga_volume_2021 <- window(exporta_manga_volume, end=c(2021,12))

exporta_manga_volume_2022 <- window(exporta_manga_volume, end=c(2022,12))

exporta_manga_volume_23 <- as.matrix(tail(exporta_manga_volume,mes)) #ajustar mensalmente
exporta_manga_volume_2023 <- matrix(NA, nrow=12, ncol=1)

for(i in 1:mes){
  exporta_manga_volume_2023[i,1] = exporta_manga_volume_23[i,1]
}
  
#Como só se tem até a semana 12
medias20_vol <- medias20_vol[1:12]

matrix_vol = matrix(NA, nrow=12, ncol=2)

for(i in 1:12){
  matrix_vol[i,1] = min(seas20_vol$season[,i])
  matrix_vol[i,2] = max(seas20_vol$season[,i])
}

#time <- c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", #"Dezembro")
#time <-seq(1:12)
table_volume <- data.frame(meses, round(matrix_vol[,1],0), round(medias20_vol,0), round(matrix_vol[,2],0), round(tail(exporta_manga_volume_2021,12),0),
round(tail(exporta_manga_volume_2022,12),0), round(exporta_manga_volume_2023[,1],0))
colnames(table_volume) = c('Meses', 'Mínimo', 'Média', 'Máximo', '2021', '2022', '2023')

tablea_vol <- table_volume[,-c(2,4:7)]
tableb_vol <- table_volume[,-c(2,3,4)]

tablea2_vol <- melt(tablea_vol, id.var='Meses')
tableb2_vol <- melt(tableb_vol, id.var='Meses')

mycolors <- c("lightblue3", "gray44", "gold")

g7 <- ggplot()+
  geom_col(data=tableb2_vol, aes(x=Meses, y=value, fill=variable), lwd=1,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
  geom_line(data=tablea2_vol, aes(x=Meses, y=value, colour=variable), linetype = "solid",
            size = 1)+
  scale_colour_manual(values = c("chocolate")) +
  scale_y_continuous(limits = c(0, 50000), n.breaks = 10)+
  scale_x_date(date_breaks = "1 month",
               labels = date_format("%B"))+
  labs(y= "Toneladas", x= "Meses do Ano", title='Exportações de Manga do Vale do S. Francisco: valores e estatísticas mensais.',
       caption = "")+
  theme_minimal()+ #Definindo tema
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=20)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g7) %>%
  layout(legend = list(
    orientation = "h", 
    x=0.25, 
    y=-0.2,
    title=''))
```

<br>

# Sazonalidade Determinística

<br>

A *sazonalidade* pode ser de natureza **determinística** ou **estocástica**. A sazonalidade determinística é aquela que tem um padrão previsível a partir de meses anteriores e normalmente está relacionada com a influência de fenomenos climáticos ou datas específicas que se repetem ano a ano.

<br>

## Sazonalidade - Regressão

<br>

A sazonalidade determinística pode ser analisada pelo **método de regressão** com o uso de *dummies*. Considere: 

<br>

$$
Y_t=T_t+S_t+\epsilon_t
$$
<br>

em que a tendência é dada por por $T_t=\sum_{j=0}^{k}\beta_jt^j$;

Se a sazonalidade é determinística, o padrão sazonal não varia a cada ano e pode ser representado por 12 dummies sazonais $S_t=\sum_{j=1}^{12}\alpha_jd_{jt}$

Cada série de dummy sazonal da variável "y" pode ser facilmente gerada no R pelo comando ``dseas1 <- seasonaldummy(y) ``. Se a restrição $\sum_{j=i}^{12}d_j=0$ for usada, $\alpha_j$ representa o efeito sazonal do período "s" comparado com uma linha de tendencia média.
	
Estima-se o seguinte modelo:

<br>

$$
Y_t=\sum_{j=0}^{k}\beta_jt^j+\sum_{j=1}^{11}\alpha_jD_{jt}+\epsilon_t
$$
<br>

os coeficientes $\alpha_1, \alpha_2, \dots, \alpha_12$ são as constantes sazonais. 

Dado que $\sum_{j=i}^{12}d_j=0$, $\alpha_{12}=-(\alpha_1+\alpha_2+ \dots+ \alpha_{11})$

<br>

## Exemplo Sazonalidade Determinística por regressão no R

<br>

``` {r econ7, warning=FALSE, message=FALSE}
#Geracao das variaveis Dummy Sazonais
exporta_manga_volume1 <- window(exporta_manga_volume, end=c(2022,12))
trend_volume <- ts(trend_volume, start=c(2012,1), freq=12)
trend_volume1 <- window(trend_volume, end=c(2022,12))
trend_volume1 <- trend_volume1[,2] 

dseas1 <- seasonaldummy(exporta_manga_volume1)
for(i in c(12, 24, 36, 48, 60, 72, 84, 96, 108, 120, 132)) {
  dseas1[i,] <- -1
}

#resultados ficarem com 4 casas decimais
#options(digits=4) 

regressao1 <- lm(exporta_manga_volume1 ~ trend_volume1 + dseas1)
summary(regressao1)

# Organização dos Coeficientes da Regressão 

coeffs <- coefficients(regressao1) #salva os coeficientes do modelo

#Calculo do efeito sazonal para dezembro como sendo o 
#negativo do somatorio dos outros meses

dezembro <- as.data.frame(-(coeffs[3]+coeffs[4]+coeffs[5]+coeffs[6]+coeffs[7]+
                              coeffs[8]+coeffs[9]+coeffs[10]+coeffs[11]
                            +coeffs[12]+coeffs[13]))

colnames(dezembro)[1] <- "coeffs"
rownames(dezembro)[1] <- "Dezembro"

#salva os coeficientes estimados em um data frame
coeffs <- as.data.frame(coeffs) 
rownames(coeffs) <- c("intercepto", "tendencia", "Janeiro", "Fevereiro", "Março",
                      "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", 
                      "Outubro", "Novembro")

# adiciona uma linha no primeiro data frame, juntando dezembro
# com os demais meses
indices_sazonais <- bind_rows(coeffs, dezembro) 

#retira as duas primeiras linhas
indices_sazonais <- indices_sazonais %>% slice(-(1:2)) 

#cria uma variável "meses"
indices_sazonais$meses <- c("Janeiro", "Fevereiro", "Março",
                      "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", 
                      "Outubro", "Novembro", "Dezembro")

#Transforma a variável em um factor para fazer o gráfico sem mudar
#a ordem do eixo do x
indices_sazonais$meses <- factor(indices_sazonais$meses, levels = indices_sazonais$meses)

#Gráfico

mycolor1 <- "blue" #escolhe a cor do gráfico

ggplot(data=indices_sazonais, aes(x=meses, y=coeffs, fill="Indices Sazonais"))+
  geom_col()+
    scale_fill_manual(values=mycolor1)+
    labs(y= "Índices Sazonais", x= "Meses", title='Analise de Sazonalidade Exportações de Manga por Regressão',
       caption = "")+
    theme_minimal()+ #Definindo tema
    theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=14, margin = margin(l=20)),
        axis.title.x = element_text(size=14, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=14, face = "bold", margin = margin(l=40)),
        plot.title = element_text(hjust = 0.5, size=16, face="italic"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = 'bottom',
        legend.title = element_blank()) # Definindo posição da legenda
```


<br>
